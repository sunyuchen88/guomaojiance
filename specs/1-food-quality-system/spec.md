# Feature Specification: 食品质检系统

**Feature Branch**: `1-food-quality-system`
**Created**: 2025-11-19
**Status**: Draft
**Input**: 开发一个食品质检系统,详细需求请参考req.md文档并严格遵循文档要求

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 检测数据获取与同步 (Priority: P1)

检测人员需要从客户系统获取待检测样品信息,并在本地系统中查看和编辑这些信息。

**Why this priority**: 这是整个检测流程的起点,没有样品数据就无法进行后续的检测工作,是最核心的功能。

**Independent Test**: 检测人员可以独立完成"登录系统 → 点击获取数据 → 查看样品列表 → 编辑检测信息"的完整流程,无需依赖其他功能。

**Acceptance Scenarios**:

1. **Given** 检测人员已登录系统, **When** 点击"获取数据"按钮, **Then** 系统成功调用客户方API并显示最新的待检测样品列表,包含质检编号、样品名称、送检公司、采样时间等核心字段
2. **Given** 样品列表已显示, **When** 检测人员点击某条记录的"检测信息编辑"按钮, **Then** 打开详细编辑界面,显示完整的样品信息(包括检测项目、检测方法、检测依据、指标值等)
3. **Given** 处于编辑界面, **When** 检测人员修改样品信息并保存, **Then** 系统成功保存修改并返回列表页,显示更新后的数据

---

### User Story 2 - 检测结果录入与报告上传 (Priority: P1)

检测人员完成样品检测后,需要录入检测结果、判定合格/不合格,并上传检测报告PDF文件。

**Why this priority**: 这是检测工作的核心输出,直接关系到检测业务的交付,与数据获取同等重要。

**Independent Test**: 检测人员可以独立完成"选择样品 → 点击检测结果修改 → 填写检测项目/结果/指标 → 上传PDF报告 → 保存"的完整流程。

**Acceptance Scenarios**:

1. **Given** 检测人员已选择一条待检测样品, **When** 点击"检测结果修改"按钮, **Then** 打开检测结果录入界面,显示3个核心字段:检测项目、检测结果(合格/不合格下拉选择)、检测指标
2. **Given** 处于结果录入界面, **When** 检测人员填写完3个核心字段并点击上传报告, **Then** 系统仅允许上传PDF格式文件,上传成功后显示文件名和大小
3. **Given** 检测结果和报告已填写完整, **When** 检测人员点击保存, **Then** 系统保存检测结果并更新样品状态为"已检测"

---

### User Story 3 - 检测结果提交至客户系统 (Priority: P1)

检测人员核实检测结果无误后,需要将完整的检测数据(包括检测结果和报告)提交至客户方系统。

**Why this priority**: 这是检测流程的最后一步,直接影响客户能否及时获取检测结果,与前两个步骤构成完整闭环。

**Independent Test**: 检测人员可以独立完成"选择已检测样品 → 点击提交检测结果 → 确认提交 → 系统自动调用客户API上传数据"的流程。

**Acceptance Scenarios**:

1. **Given** 检测人员已完成检测结果录入和报告上传, **When** 点击"提交检测结果"按钮, **Then** 系统弹出确认对话框,显示即将提交的检测结果摘要信息
2. **Given** 确认对话框已显示, **When** 检测人员确认提交, **Then** 系统调用客户方API(POST /admin/api/test/check/feedback),发送检测数据和报告URL
3. **Given** API调用成功(返回status=200), **When** 系统收到成功响应, **Then** 更新样品状态为"已提交",显示提交成功消息和提交时间
4. **Given** API调用失败(返回status=400或网络错误), **When** 系统收到失败响应, **Then** 保留样品为"已检测"状态,显示失败原因并允许重新提交

---

### User Story 4 - 检测数据导出与下载 (Priority: P2)

检测人员和管理人员需要下载已上传的检测报告PDF文件和导出检测结果Excel表格,用于存档、分发或数据分析。

**Why this priority**: 这是辅助功能,用于报告管理和数据分析,虽然重要但不阻塞核心检测流程。

**Independent Test**: 用户可以独立完成"选择样品 → 点击下载报告/导出Excel → 获得文件"的流程。

**Acceptance Scenarios**:

1. **Given** 样品已上传检测报告, **When** 用户点击"下载报告"按钮, **Then** 浏览器下载对应的PDF文件,文件名包含质检编号和样品名称
2. **Given** 样品尚未上传报告, **When** 用户点击"下载报告"按钮, **Then** 系统显示"暂无报告"提示,按钮置灰不可点击
3. **Given** 用户选择了一个或多个已完成检测的样品, **When** 点击"导出Excel"按钮, **Then** 系统生成并下载Excel文件,包含样品名称、公司/个体、检测项目、检验结果、该项结果、检测时间、样品编号、检测方法等字段
4. **Given** 用户未选择任何样品, **When** 点击"导出Excel"按钮, **Then** 系统导出当前查询条件下的所有样品检测结果(最多1000条,超过提示分批导出)
5. **Given** 用户导出Excel文件, **When** 打开文件, **Then** Excel包含表头行和数据行,每个检测项目独立占一行(一个样品多个检测项目会生成多行),格式规范易于阅读

---

### User Story 5 - 多维度查询与过滤 (Priority: P2)

用户需要通过多种条件快速查找特定的检测项目,包括状态筛选、公司名称、检测编号、采样时间等。

**Why this priority**: 这是提升使用效率的功能,随着检测数据增多变得越来越重要,但初期数据量少时可以手动翻页。

**Independent Test**: 用户可以独立完成"输入查询条件 → 点击查询 → 查看过滤后的结果列表"的流程。

**Acceptance Scenarios**:

1. **Given** 用户位于样品列表页, **When** 选择状态为"待检测"并点击查询, **Then** 列表仅显示状态为"待检测"的样品
2. **Given** 用户位于样品列表页, **When** 输入公司名称"大洋智慧科技有限公司"并点击查询, **Then** 列表仅显示该公司的样品
3. **Given** 用户位于样品列表页, **When** 输入检测编号"CN20250319001"并点击查询, **Then** 列表显示该编号的唯一样品或提示"无匹配结果"
4. **Given** 用户位于样品列表页, **When** 选择采样时间范围"2025-03-18至2025-03-20"并点击查询, **Then** 列表仅显示该时间范围内的样品
5. **Given** 用户设置了多个过滤条件, **When** 点击"重置"按钮, **Then** 清空所有过滤条件并显示全部样品

---

### User Story 6 - 账号密码登录认证 (Priority: P1)

检测人员需要通过账号和密码登录系统,确保只有授权人员能够访问和操作检测数据。

**Why this priority**: 这是系统的安全基础,必须在任何业务功能之前实现,保护敏感检测数据。

**Independent Test**: 用户可以独立完成"访问登录页 → 输入账号密码 → 点击登录 → 进入系统主页"的流程。

**Acceptance Scenarios**:

1. **Given** 用户访问系统登录页, **When** 输入正确的账号和密码并点击登录, **Then** 系统验证通过,跳转至样品列表主页并显示欢迎信息
2. **Given** 用户访问系统登录页, **When** 输入错误的账号或密码并点击登录, **Then** 系统显示"账号或密码错误"提示,停留在登录页
3. **Given** 用户访问系统登录页, **When** 账号或密码字段为空时点击登录, **Then** 系统显示"请输入账号和密码"验证提示
4. **Given** 用户已登录系统, **When** 超过2小时无操作, **Then** 系统自动退出登录,下次访问需要重新登录

---

### Edge Cases

- **并发获取数据**: 多个检测人员同时点击"获取数据"按钮时,系统如何处理?确保不会重复拉取或造成数据混乱
- **客户API不可用**: 当客户方API服务宕机或网络中断时,系统如何提示并允许稍后重试?
- **大文件上传**: 检测报告PDF文件较大(如超过10MB)时,上传是否会超时?是否需要显示上传进度?
- **重复提交检测结果**: 检测人员误点击多次"提交检测结果"按钮,系统如何防止重复提交?
- **检测结果修改历史**: 检测人员修改已提交的检测结果时,系统是否需要保留修改历史和审计日志?
- **批量操作**: 是否需要支持批量下载报告或批量提交检测结果?
- **自动同步与手动同步冲突**: 当定时任务正在自动同步数据时,检测人员手动点击"获取数据"按钮,系统如何处理避免冲突?
- **定时同步失败**: 自动定时同步任务失败时(如API不可用),系统如何记录并通知检测人员?
- **文件存储空间管理**: 随着检测报告不断上传,本地服务器存储空间可能不足,系统如何监控和预警?
- **文件访问权限**: 存储在本地服务器的PDF报告,是否需要访问权限控制?还是允许任何人通过URL访问?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供账号密码登录功能,验证用户身份后方可访问
- **FR-002**: 系统必须支持调用客户方API获取待检测样品数据,并在列表中显示核心字段(质检编号、样品名称、送检公司、采样时间、检测类型、状态等)
- **FR-003**: 系统必须实现自动定时同步功能,每30分钟自动调用客户方API拉取最新样品数据,同时保留手动"获取数据"按钮供即时刷新使用
- **FR-004**: 系统必须处理定时同步与手动同步的并发控制,确保同一时间只有一个同步任务在执行,避免数据冲突
- **FR-005**: 系统必须记录每次数据同步的结果(成功/失败)、时间戳和拉取数量,供故障排查使用
- **FR-006**: 系统必须支持检测人员编辑样品的详细信息,包括检测项目明细、检测方法、检测依据、指标值等
- **FR-007**: 系统必须支持检测人员录入检测结果的3个核心字段:检测项目、检测结果(合格/不合格)、检测指标
- **FR-008**: 系统必须支持上传检测报告,仅允许PDF格式,文件大小限制为10MB以内
- **FR-009**: 系统必须将上传的PDF报告存储在应用服务器的本地文件系统中,路径结构为: /uploads/reports/{year}/{month}/{质检编号}_{timestamp}.pdf
- **FR-010**: 系统必须为每个上传的报告生成可通过HTTP访问的URL,格式为: http(s)://{服务器域名}/reports/{year}/{month}/{文件名}.pdf
- **FR-011**: 系统必须支持检测人员提交检测结果至客户方API,发送完整的检测数据和报告URL(check_result_url)
- **FR-012**: 系统必须处理客户方API的成功和失败响应,成功时更新样品状态为"已提交",失败时保留"已检测"状态并显示错误信息
- **FR-013**: 系统必须支持下载已上传的检测报告PDF文件
- **FR-013A**: 系统必须支持导出检测结果为Excel文件,包含以下字段:样品名称、公司/个体、检测项目、检验结果(数值)、该项结果(合格/不合格)、检测时间、样品编号、检测方法
- **FR-013B**: 系统必须支持导出选定样品的检测结果或导出当前查询条件下的所有样品结果(最多1000条)
- **FR-013C**: 系统导出的Excel文件格式必须将每个检测项目展开为独立行,一个样品包含多个检测项目时生成多行记录
- **FR-014**: 系统必须支持按状态筛选样品(如:待检测、已检测、已提交)
- **FR-015**: 系统必须支持按公司名称、检测编号、采样时间范围进行查询和过滤
- **FR-016**: 系统必须记录样品状态变更(待检测 → 已检测 → 已提交),并显示每个状态的时间戳
- **FR-017**: 系统必须实现与客户方API的签名认证机制(md5加密签名),使用固定配置的app_id(689_abc)和密钥(67868790)
- **FR-018**: 系统必须将客户方API的认证信息(app_id、密钥、API基础URL)配置在系统配置文件或环境变量中,便于部署时修改
- **FR-019**: 系统必须支持分页显示样品列表,默认每页50条,最大50条
- **FR-020**: 系统必须在会话超时(2小时无操作)后自动退出登录
- **FR-021**: 系统必须监控本地文件存储空间使用情况,当可用空间低于10GB时在管理后台显示预警信息

### Key Entities

- **检测样品(CheckObject)**: 代表一个待检测或已检测的样品,包含以下核心属性:
  
  - 质检对象ID (check_object_id)
  - 质检联合编号 (check_object_union_num)
  - 二维码URL (code_url)
  - 送检货物ID和名称 (submission_goods_id, submission_goods_name)
  - 送检货物产地、位置、单位、车牌号 (submission_goods_area, location, unit, car_number)
  - 送检方式、人员、手机号、公司 (submission_method, person, mobile, company)
  - 司机、司机手机 (driver, driver_mobile)
  - 检测类型 (check_type)
  - 状态 (status: 0=待检测, 1=已检测, 2=已提交)
  - 是否接收 (is_receive)
  - 检测开始/结束时间 (check_start_time, check_end_time)
  - 创建人、创建时间 (create_admin, create_time)

- **检测项目明细(CheckObjectItem)**: 代表样品中的具体检测项目,包含:
  
  - 检测项目明细ID (check_object_item_id)
  - 关联的质检对象ID (check_object_id)
  - 检测项目ID和名称 (check_item_id, check_item_name)
  - 检测结果数值 (num)
  - 检测结果(合格/不合格) (result)
  - 检测时间 (check_time)
  - 检测人员 (check_admin)
  - 状态 (status)
  - 创建时间 (create_time)
  - 参考值 (reference_value)
  - 检测项(CheckItem): 包含检测项目详细信息
    - 检测项ID (item_id)
    - 检测项目名称 (name)
    - 检测方法ID (method_id)
    - 检测方法名称 (method_name)
    - 检测依据ID和名称 (basic_id, basic_name)
    - 检测指标ID和名称 (indicators_id, indicators_name)
    - 参考值 (reference_values)
    - 费用 (fee)

- **检测结果(CheckResult)**: 代表提交给客户方的检测结果数据,包含:
  
  - 质检编号组合 (check_no_join): 多个样品的编号用逗号分隔
  - 样品数量 (check_num)
  - 样品数组 (goods): 每个样品包含质检编号、检测时间、报告URL、检测结果(合格/不合格)
  - 检测项目数组 (item): 每个检测项包含ID、名称、结果、指标值

- **用户(User)**: 代表检测人员,包含:
  
  - 账号 (username)
  - 密码 (password, 加密存储)
  - 姓名 (name)
  - 角色 (role: 检测员、管理员)
  - 创建时间 (created_at)
  - 最后登录时间 (last_login_at)

- **数据同步日志(SyncLog)**: 记录每次数据同步操作,包含:
  
  - 同步ID (sync_id)
  - 同步类型 (sync_type: auto=自动定时同步, manual=手动触发)
  - 同步状态 (status: success=成功, failed=失败, in_progress=进行中)
  - 开始时间 (start_time)
  - 结束时间 (end_time)
  - 拉取数量 (fetched_count)
  - 错误信息 (error_message, 失败时记录)
  - 执行人 (operator, 手动触发时记录)

- **系统配置(SystemConfig)**: 存储系统配置信息,包含:
  
  - 客户方API基础URL (api_base_url)
  - 客户方app_id (client_app_id)
  - 客户方密钥 (client_secret, 加密存储)
  - 自动同步间隔(分钟) (sync_interval_minutes, 默认30)
  - 文件存储路径 (file_storage_path)
  - 服务器域名 (server_domain, 用于生成报告URL)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 检测人员可以在1分钟内完成从获取数据到查看样品列表的完整流程
- **SC-002**: 检测人员可以在3分钟内完成单个样品的检测结果录入和报告上传
- **SC-003**: 90%的检测结果提交能在首次尝试时成功传输至客户系统
- **SC-004**: 检测人员能够在30秒内通过查询功能找到特定的检测样品

### Performance Requirements *(per constitution)*

- **PERF-001**: 登录验证响应时间 < 500ms (P95)
- **PERF-002**: 获取样品数据(调用客户API)响应时间 < 2秒 (P95)
- **PERF-003**: 样品列表页面加载时间(含50条数据)< 1秒 (P95)
- **PERF-004**: 检测结果提交(调用客户API)响应时间 < 3秒 (P95)
- **PERF-005**: 报告下载开始响应时间 < 500ms (P95)
- **PERF-006**: 系统支持至少10个并发用户同时操作,无明显性能下降
- **PERF-007**: PDF报告上传(10MB文件)时间 < 30秒

### Quality Requirements *(per constitution)*

- **QUAL-001**: 测试覆盖率 ≥ 80% (核心业务逻辑如API调用、数据提交、文件上传 = 100%)
- **QUAL-002**: 可访问性合规: WCAG 2.1 AA级别(登录页、列表页、编辑表单支持键盘导航,错误提示清晰)
- **QUAL-003**: 代码质量: 圈复杂度 ≤ 10 per function
- **QUAL-004**: 所有用户操作在200ms内提供视觉反馈(按钮点击、表单提交显示加载状态)
- **QUAL-005**: API调用失败时提供明确的错误信息和重试选项
- **QUAL-006**: 所有敏感数据(用户密码、API密钥)必须加密存储
- **QUAL-007**: 所有状态变更必须记录操作人员和时间戳,支持审计追溯

## Assumptions and Constraints

### Assumptions

- **单一客户对接**: 系统当前仅需对接一个固定客户(国贸食品科学研究院的客户方),使用固定的API认证信息(app_id: 689_abc, 密钥: 67868790)
- **检测报告规模**: 预计每月检测报告数量在100-500份之间,每份报告平均大小2-5MB,年度存储需求约6-30GB
- **用户规模**: 系统主要服务检测机构内部人员,预计并发用户数不超过10人
- **网络环境**: 系统部署在检测机构内部网络,与客户方API之间网络连接稳定
- **数据同步频率**: 客户方每30分钟左右会有新的待检测样品提交,自动同步间隔设定为30分钟可满足业务需求

### Constraints

- **文件存储方案**: 采用本地文件服务器存储方案,PDF报告存储在应用服务器本地文件系统(/uploads/reports/{year}/{month}/),通过HTTP静态文件服务提供访问
  
  - 优点: 实现简单,无需额外云服务成本
  - 限制: 需要定期监控存储空间,考虑数据备份方案;服务器故障会影响历史报告访问;不支持分布式部署
  - 缓解措施: FR-021要求监控存储空间并在低于10GB时预警;建议定期备份/uploads目录到外部存储

- **API认证配置**: 客户方API认证信息采用单客户固定配置,硬编码业务逻辑仅对接当前客户
  
  - 优点: 实现最简单,代码逻辑清晰
  - 限制: 如需对接新客户或更换客户,需要修改配置并重新部署;不支持多客户并存
  - 缓解措施: FR-018要求将认证信息配置在环境变量或配置文件中,方便更换客户时修改

- **数据同步策略**: 采用自动定时同步(每30分钟)+手动触发的混合方案
  
  - 优点: 减少检测人员手动操作,数据自动保持更新;保留手动按钮用于即时刷新
  - 限制: 定时任务失败时可能延迟获取新样品;增加系统复杂度
  - 缓解措施: FR-004和FR-005要求并发控制和同步日志记录,确保可靠性和可追溯性

- **性能和扩展性**: 系统设计针对小规模检测机构使用场景(≤10并发用户)
  
  - 如未来需要支持更大规模(如多个检测机构共用一套系统),需要重新评估架构:
    - 文件存储可能需要迁移至对象存储(OSS/COS)
    - API认证配置需要支持多客户管理
    - 数据库和应用服务器需要支持水平扩展

- **安全性**: 系统部署在内部网络,PDF报告URL默认无访问权限控制
  
  - 假设: 内部网络环境可信,报告URL不会泄露给外部人员
  - 风险: 如果URL泄露,任何人都可以访问报告内容
  - 建议: 如需提升安全性,可在后续版本中为报告URL添加时效性token或访问权限验证
